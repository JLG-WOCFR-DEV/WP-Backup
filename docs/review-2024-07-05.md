# Revue du plugin Backup JLG – 5 juillet 2024

## Synthèse
- **Architecture et sécurité** : l’API REST intègre un filtrage strict des clés (hachage systématique, purge des champs sensibles, association obligatoire à un utilisateur existant) et combine authentification par clé, JWT ou capacités WordPress avec limitation de débit. 【F:backup-jlg/includes/class-bjlg-rest-api.php†L340-L379】【F:backup-jlg/includes/class-bjlg-rest-api.php†L560-L646】
- **Debugging & observabilité** : la couche de logging fournit une journalisation structurée avec contexte (fichier, ligne, fonction), exposes des helpers pour consulter/réinitialiser les journaux plugin/wp et propose un fallback d’interface pour activer/désactiver les modules en environnement dégradé. 【F:backup-jlg/includes/class-bjlg-debug.php†L40-L135】【F:backup-jlg/class-bjlg-debug-ui.php†L60-L150】
- **Accessibilité** : le shell d’administration inclut des éléments structurants (lien d’évitement, boutons vocaux, régions nommées) et un commutateur de contraste, ce qui va dans le sens des exigences RGAA. 【F:backup-jlg/includes/class-bjlg-admin.php†L552-L630】
- **Points de vigilance majeurs** : une erreur de typage dans `BJLG_Debug::log_exception()` provoquera une fatal error dès qu’on lui passe une instance `\Exception`. Par ailleurs, les panneaux React sont livrés avec un attribut `aria-labelledby` qui pointe vers des identifiants inexistants, ce qui crée une non‑conformité RGAA en cas d’échec du JavaScript. 【F:backup-jlg/includes/class-bjlg-debug.php†L310-L323】【F:backup-jlg/includes/class-bjlg-admin.php†L663-L671】

## Bugs / risques critiques
1. **Type hint incorrect dans `BJLG_Debug::log_exception()`** : la classe étant namespacée, l’argument `Exception $e` tente de résoudre `BJLG\Exception`. Toute tentative de log d’une exception native générera donc un fatal error (`TypeError`). Il faut importer `\Exception` ou préfixer le type (`\Exception $e`). 【F:backup-jlg/includes/class-bjlg-debug.php†L310-L323】
2. **Attribut `aria-labelledby` orphelin sur les panneaux React** : chaque `<section role="tabpanel">` référence `bjlg-tab-…`, mais aucun élément ne porte cet identifiant dans le DOM initial. Avant l’hydratation React, les aides techniques rencontrent un ID invalide (critère RGAA 4.1). Il est recommandé d’associer ces panneaux à un titre présent dans le balisage statique (ex. le `<h2>` interne) ou d’injecter les bons identifiants côté PHP. 【F:backup-jlg/includes/class-bjlg-admin.php†L663-L671】

## Debugging & observabilité
- **Log enrichi et consultation facilitée** : `BJLG_Debug::log()` ajoute automatiquement le fichier, la ligne et la fonction appelante, verrouille les écritures et bascule sur `error_log` en cas d’échec, ce qui garantit une traçabilité fiable. Les méthodes `get_plugin_log_content()` et `get_wp_error_log_content()` offrent une lecture paginée sans charger tout le fichier. 【F:backup-jlg/includes/class-bjlg-debug.php†L40-L135】
- **Fallback admin robuste** : la page `Debug & Modules` reste accessible même si d’autres modules tombent en panne, avec un filtrage instantané et des feedbacks `aria-live` pour suivre l’état des tests. Cela facilite le diagnostic sur site cassé. 【F:backup-jlg/class-bjlg-debug-ui.php†L60-L150】
- **Améliorations possibles** :
  - Ajouter une rotation/limite pour `BJLG_Debug::$logs` afin d’éviter la croissance illimitée en mémoire durant des suites de tests longues.
  - Reporter les erreurs réseau du bouton “Tester” côté JS dans le log serveur (actuellement seule l’UI affiche “Erreur réseau”), afin d’avoir une trace en production.
  - Corriger la signature de `log_exception()` (voir ci‑dessus) pour restaurer la journalisation des exceptions critiques.

## Conformité Accessibilité (RGAA)
- **Points conformes observés** :
  - Lien d’évitement vers le contenu principal, zones de navigation labellisées, boutons de menu et de contraste avec texte vocal (`screen-reader-text`) et gestion d’état via `aria-pressed`. 【F:backup-jlg/includes/class-bjlg-admin.php†L552-L630】
  - Composants dynamiques (filtres des modules) utilisant `role="status"`/`aria-live="polite"` pour annoncer les changements, et contrôles de formulaire associés à des étiquettes descriptives. 【F:backup-jlg/class-bjlg-debug-ui.php†L96-L142】
  - Palette respectant un contraste >4.5:1 pour les retours d’état (succès/erreur/chargement) et possibilité native d’activer un thème à contraste renforcé.
- **Non‑conformités / risques** :
  - `aria-labelledby` sans cible (voir bug #2) rompt l’association label/panneau et contrevient au critère 4.1 du RGAA.
  - Lors du passage d’un onglet, le focus reste sur le déclencheur ; envisager de déplacer le focus sur le panneau actif (ou d’annoncer le changement via `wp.a11y.speak`) pour satisfaire le critère 7.4 (navigation cohérente).
  - Vérifier que les schémas de couleurs “clair” et “contraste renforcé” maintiennent un ratio ≥ 4.5:1 pour tout le texte secondaire (certaines teintes pastel pourraient descendre à ~4.2:1 sur écrans calibrés différemment).

## Recommandations supplémentaires
- **Correctifs immédiats** : importer `\Exception` dans `BJLG_Debug` et lier chaque panneau à un identifiant existant (par exemple en utilisant le `<h2>` interne) afin de lever les régressions critiques.
- **Accessibilité** : ajouter un `aria-live` global ou un message vocal lors du changement de section, et documenter les contrastes du thème sombre pour simplifier les audits RGAA ultérieurs.
- **Sécurité & maintenance** : garder le mécanisme de hachage/rotation des clés API et envisager un outil d’expiration automatique (cron) basé sur `expires` pour supprimer les clés périmées sans passage par `verify_api_key()`.
